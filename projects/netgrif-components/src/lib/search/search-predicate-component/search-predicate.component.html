<div class="predicate-body"
     [ngClass]="!!selectedCategory && selectedCategory.providesPredicate ? 'predicate-body-color' : 'white-background'">
    <div fxLayout="row" fxLayoutAlign="start stretch">
        <div fxLayout="row" fxLayoutAlign="center center">
            <button mat-icon-button color="warn" (click)="remove()">
                <mat-icon>clear</mat-icon>
            </button>
        </div>

        <div *ngIf="!selectedCategory; then categorySelection else categoryDisplay"></div>
        <ng-template #categorySelection>
            <mat-form-field class="text-margin">
                <mat-label>{{'search.category.select' | translate}}</mat-label>
                <mat-select class="category-select" (selectionChange)="categoryChanged($event.value)" #categoryInput>
                    <mat-option *ngFor="let category of searchCategories"
                                [value]="category">{{category.translationPath | translate}}</mat-option>
                </mat-select>
            </mat-form-field>
        </ng-template>
        <ng-template #categoryDisplay>
            <div fxLayout="row" fxLayoutAlign="start center" class="text-margin"
                 [ngClass]="{'bold-text': selectedCategory.displayBold}"
                 (click)="clearCategorySelection()">
                {{selectedCategory.translationPath | translate}}
            </div>
        </ng-template>

        <div *ngIf="selectedCategory" fxLayout="row" fxLayoutAlign="start center">
            <ng-template ngFor let-configurationInput [ngForOf]="selectedCategory.configurationInputs$ | async" let-i="index">
                <div [ngSwitch]="configurationInput">
                    <ng-template [ngSwitchCase]="searchInputType.AUTOCOMPLETE">
                        <div *ngIf="!selectedCategory.isAutocompleteConfigurationSelected(i); then configurationSelection else configurationDisplay"></div>

                        <ng-template #configurationSelection>
                            <mat-form-field class="text-margin">
                                <input type="text" matInput
                                       #autocompleteInput
                                       #autocompleteTrigger="matAutocompleteTrigger"
                                       [formControl]="selectedCategory.getActiveInputFormControl(i)"
                                       [matAutocomplete]="configurationAutocomplete"
                                       (keydown.enter)="$event.target.blur(); autocompleteTrigger.closePanel()"
                                       #configurationInput>
                                <mat-autocomplete #configurationAutocomplete="matAutocomplete"
                                                  [displayWith]="renderSelection"
                                                  (optionSelected)="autocompleteInput.blur()">
                                    <mat-option
                                        *ngFor="let option of selectedCategory.getFilteredAutocompleteConfigurationOptions(i) | async"
                                        [value]="option">
                                        <mat-icon *ngIf="option.icon">{{option.icon}}</mat-icon>
                                        <span>{{option.text}}</span>
                                    </mat-option>
                                </mat-autocomplete>
                            </mat-form-field>
                        </ng-template>

                        <ng-template #configurationDisplay>
                            <div class="text-margin"
                                 [ngClass]="{'bold-text': selectedCategory.isAutocompleteConfigurationDisplayBold(i)}"
                                 (click)="selectedCategory.clearAutocompleteConfigurationInput(i)">
                                {{selectedCategory.getAutocompleteConfigurationSelectedOptionTranslatePath(i) | translate}}
                            </div>
                        </ng-template>
                    </ng-template>
                    <ng-template [ngSwitchCase]="searchInputType.OPERATOR">
                        <div *ngIf="selectedCategory.isOperatorSelected(); then argumentsSelection; else operatorSelection"></div>

                        <ng-template #operatorSelection>
                            <mat-form-field>
                                <mat-select [formControl]="selectedCategory.getActiveInputFormControl(i)" #configurationInput>
                                    <mat-option *ngFor="let operator of selectedCategory.allowedOperators" [value]="operator">
                                        <div fxLayout="row" fxLayoutAlign="start center">
                                            <ng-template ngFor let-namePart [ngForOf]="operator.getOperatorNameTemplate()">
                                                <div *ngIf="!!namePart; else operatorInputPlaceholder">{{namePart | translate}}</div>
                                            </ng-template>
                                            <ng-template #operatorInputPlaceholder>
                                                <div class="argument-placeholder-color argument-placeholder-dimensions"></div>
                                            </ng-template>
                                        </div>
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </ng-template>

                        <ng-template #argumentsSelection>
                            <div fxLayout="row" fxLayoutAlign="start center" (click)="selectedCategory.clearOperatorSelection()">
                                <ng-template ngFor let-templatePart [ngForOf]="selectedCategory.operatorTemplate$ | async" let-last="last"
                                             [ngForTrackBy]="trackByTemplateParts">
                                    <div [ngSwitch]="templatePart.type">
                                        <ng-template [ngSwitchCase]="operatorTemplatePartType.TEXT">
                                            <div fxLayout="row" fxLayoutAlign="start center"
                                                 [ngClass]="{'text-margin': !last}">
                                                {{templatePart.content | translate}}
                                            </div>
                                        </ng-template>

                                        <ng-template [ngSwitchCase]="operatorTemplatePartType.INPUT">
                                            <div [ngClass]="{'text-margin': !last}"
                                                 (click)="$event.stopPropagation()">
                                                <nc-search-operand-input [inputFormControl]="templatePart.content"
                                                                         [inputType]="selectedCategory.inputType"
                                                                         [filterOptionsFunction]="filterOptions"></nc-search-operand-input>
                                            </div>
                                        </ng-template>
                                    </div>
                                </ng-template>
                            </div>
                        </ng-template>
                    </ng-template>
                </div>
            </ng-template>
        </div>
    </div>
</div>
