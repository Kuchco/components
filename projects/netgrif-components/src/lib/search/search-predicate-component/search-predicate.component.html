<div class="predicate-border">
    <div fxLayout="row" fxLayoutAlign="start stretch">
        <div fxLayout="row" fxLayoutAlign="center center">
            <button mat-icon-button color="warn" (click)="remove()">
                <mat-icon>clear</mat-icon>
            </button>
        </div>

        <mat-form-field>
            <mat-label>{{'search.category.select' | translate}}</mat-label>
            <mat-select class="category-select" (selectionChange)="categoryChanged($event.value)">
                <mat-option *ngFor="let category of searchCategories"
                            [value]="category">{{category.translationPath | translate}}</mat-option>
            </mat-select>
        </mat-form-field>

        <div *ngIf="selectedCategory" fxLayout="row" fxLayoutAlign="start center">
            <ng-template ngFor let-configurationInput [ngForOf]="selectedCategory.configurationInputs$ | async" let-i="index">
                <div [ngSwitch]="configurationInput">
                    <ng-template [ngSwitchCase]="searchInputType.AUTOCOMPLETE">
                        <mat-form-field>
                            <input type="text" matInput
                                   #autocompleteInput
                                   #autocompleteTrigger="matAutocompleteTrigger"
                                   [formControl]="selectedCategory.getActiveInputFormControl(i)"
                                   [matAutocomplete]="configurationAutocomplete"
                                   (keydown.enter)="$event.target.blur(); autocompleteTrigger.closePanel()">
                            <mat-autocomplete #configurationAutocomplete="matAutocomplete"
                                              [displayWith]="renderSelection"
                                              (optionSelected)="autocompleteInput.blur()">
                                <mat-option *ngFor="let option of selectedCategory.getFilteredAutocompleteConfigurationOptions(i) | async"
                                            [value]="option">
                                    <mat-icon *ngIf="option.icon">{{option.icon}}</mat-icon>
                                    <span>{{option.text}}</span>
                                </mat-option>
                            </mat-autocomplete>
                        </mat-form-field>
                    </ng-template>
                    <ng-template [ngSwitchCase]="searchInputType.OPERATOR">
                        <div *ngIf="selectedCategory.isOperatorSelected(); then argumentsSelection; else operatorSelection"></div>

                        <ng-template #operatorSelection>
                            <mat-form-field>
                                <mat-select [formControl]="selectedCategory.getActiveInputFormControl(i)">
                                    <mat-option *ngFor="let operator of selectedCategory.allowedOperators" [value]="operator">
                                        <div fxLayout="row" fxLayoutAlign="start center">
                                            <ng-template ngFor let-namePart [ngForOf]="operator.getOperatorNameTemplate()">
                                                <div *ngIf="!!namePart; else operatorInputPlaceholder">{{namePart | translate}}</div>
                                            </ng-template>
                                            <ng-template #operatorInputPlaceholder>
                                                <div class="argument-placeholder-color argument-placeholder-dimensions"></div>
                                            </ng-template>
                                        </div>
                                    </mat-option>
                                </mat-select>
                            </mat-form-field>
                        </ng-template>

                        <ng-template #argumentsSelection>
                            <div fxLayout="row" fxLayoutAlign="start center" (click)="selectedCategory.clearOperatorSelection()">
                                <ng-template ngFor let-templatePart [ngForOf]="selectedCategory.operatorTemplate$ | async" [ngForTrackBy]="trackByTemplateParts">
                                    <div [ngSwitch]="templatePart.type">
                                        <ng-template [ngSwitchCase]="operatorTemplatePartType.TEXT">
                                            {{templatePart.content | translate}}
                                        </ng-template>

                                        <ng-template [ngSwitchCase]="operatorTemplatePartType.INPUT">
                                            <div (click)="$event.stopPropagation()">
                                                <nc-search-operand-input [inputFormControl]="templatePart.content"
                                                                         [inputType]="selectedCategory.inputType"
                                                                         [filterOptionsFunction]="filterOptions"></nc-search-operand-input>
                                            </div>
                                        </ng-template>
                                    </div>
                                </ng-template>
                            </div>
                        </ng-template>
                    </ng-template>
                </div>
            </ng-template>
        </div>
    </div>
</div>
